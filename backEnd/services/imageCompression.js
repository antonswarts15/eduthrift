const sharp = require('sharp');\nconst path = require('path');\nconst fs = require('fs');\n\nclass ImageCompressionService {\n  constructor() {\n    this.compressionSettings = {\n      ITEM_PHOTO: {\n        maxWidth: 1200,\n        maxHeight: 1200,\n        quality: 80,\n        maxSizeKB: 500\n      },\n      DOCUMENT: {\n        maxWidth: 1500,\n        maxHeight: 1500,\n        quality: 85,\n        maxSizeKB: 800\n      },\n      PROFILE: {\n        maxWidth: 800,\n        maxHeight: 800,\n        quality: 80,\n        maxSizeKB: 300\n      }\n    };\n  }\n\n  async compressImage(inputPath, outputPath, type = 'ITEM_PHOTO') {\n    try {\n      const settings = this.compressionSettings[type];\n      const originalStats = fs.statSync(inputPath);\n      const originalSizeKB = Math.round(originalStats.size / 1024);\n\n      console.log(`Compressing ${type}: ${originalSizeKB}KB`);\n\n      // Get image metadata\n      const metadata = await sharp(inputPath).metadata();\n      \n      // Calculate resize dimensions while maintaining aspect ratio\n      let { width, height } = metadata;\n      if (width > settings.maxWidth || height > settings.maxHeight) {\n        const ratio = Math.min(settings.maxWidth / width, settings.maxHeight / height);\n        width = Math.round(width * ratio);\n        height = Math.round(height * ratio);\n      }\n\n      // Compress image\n      await sharp(inputPath)\n        .resize(width, height, {\n          fit: 'inside',\n          withoutEnlargement: true\n        })\n        .jpeg({\n          quality: settings.quality,\n          progressive: true,\n          mozjpeg: true\n        })\n        .toFile(outputPath);\n\n      // Check final size\n      const compressedStats = fs.statSync(outputPath);\n      const compressedSizeKB = Math.round(compressedStats.size / 1024);\n      const reduction = Math.round(((originalSizeKB - compressedSizeKB) / originalSizeKB) * 100);\n\n      console.log(`Compression complete: ${originalSizeKB}KB â†’ ${compressedSizeKB}KB (${reduction}% reduction)`);\n\n      // If still too large, reduce quality further\n      if (compressedSizeKB > settings.maxSizeKB) {\n        const newQuality = Math.max(60, settings.quality - 20);\n        console.log(`File still large (${compressedSizeKB}KB), reducing quality to ${newQuality}%`);\n        \n        await sharp(inputPath)\n          .resize(width, height, {\n            fit: 'inside',\n            withoutEnlargement: true\n          })\n          .jpeg({\n            quality: newQuality,\n            progressive: true,\n            mozjpeg: true\n          })\n          .toFile(outputPath);\n      }\n\n      // Clean up original file if different from output\n      if (inputPath !== outputPath) {\n        fs.unlinkSync(inputPath);\n      }\n\n      return {\n        success: true,\n        originalSize: originalSizeKB,\n        compressedSize: Math.round(fs.statSync(outputPath).size / 1024),\n        reduction: reduction\n      };\n\n    } catch (error) {\n      console.error('Image compression error:', error);\n      return {\n        success: false,\n        error: error.message\n      };\n    }\n  }\n\n  // Middleware for automatic compression\n  createCompressionMiddleware(type = 'ITEM_PHOTO') {\n    return async (req, res, next) => {\n      if (!req.files && !req.file) {\n        return next();\n      }\n\n      const files = req.files ? Object.values(req.files).flat() : [req.file];\n      \n      for (const file of files) {\n        if (file && file.mimetype.startsWith('image/')) {\n          const inputPath = file.path;\n          const outputPath = inputPath.replace(path.extname(inputPath), '_compressed.jpg');\n          \n          const result = await this.compressImage(inputPath, outputPath, type);\n          \n          if (result.success) {\n            // Update file object with compressed version\n            file.path = outputPath;\n            file.filename = file.filename.replace(path.extname(file.filename), '_compressed.jpg');\n            file.size = fs.statSync(outputPath).size;\n          }\n        }\n      }\n      \n      next();\n    };\n  }\n}\n\nmodule.exports = new ImageCompressionService();